<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rs.mapper.CarMapper">

	<!-- SEQ 조회 -->
	<select id="getSeq" parameterType="String" resultType="String">
		SELECT LPAD(NEXTVAL(${value}), 8, '0')
	</select>
	
	<!-- 차량 기본정보 목록 조회 -->
	<select id="getCarBasicInfoList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		/* com.rs.mapper.CarMapper [getCarBasicInfoList] */
		SELECT #{userNm}           AS userNm
			, CMC.USER_ID         AS userId
			, CMC.CAR_ID          AS carId
			, CMC.CAR_NO          AS carNo
			, CMC.CAR_FULL_NO     AS carFullNo
			, CMC.CAR_CP_CD       AS carCpCd
			, CMC.CAR_CP_NM       AS carCpNm
			, CONCAT(SUBSTR(BR_NO,1,3),'-',SUBSTR(BR_NO,4,2),'-',SUBSTR(BR_NO,6)) AS brNo
			, fn_car_state(CMC.CAR_ID)    AS SH_USE_YN_NM
			, CMC.USE_YN          AS useYn
			, CMC.DRIVER_NM       AS driverNm
			, CMC.CAR_CLS_CD      AS carClsCd
			, CMC.CAR_OPR_CD      AS carOprCd
			, CMC.CAR_TEMP_CD     AS carTempCd
			, CMC.CAR_MOD_CD      AS carModCd
			, CMC.CAR_LOD_CBM     AS carLodCbm
			, CMC.CAR_LOD_WGT     AS carLodWgt
			, CMC.CAR_LOD_WDT     AS carLodWdt
			, CMC.CAR_LOD_LEN     AS carLodLen
			, CMC.CAR_LOD_HGT     AS carLodHgt
			, CMC.CAR_INSR_YN     AS carInsrYn
			, CMC.CAR_INSR_DT     AS carInsrDt
			, CMC.CAR_LOD_INSR_YN AS carLodInsrYn
			, CMC.CM_PRICE        AS cmPrice
			, CMC.AREA_NM1        AS areaNm1
			, CMC.AREA_NM2        AS areaNm2
			, CMC.DT_ADDR         AS dtAddr
			, CMC.DT_ADDR2        AS dtAddr2
			, CMC.LONGI_NO        AS longiNo
			, CMC.LATI_NO         AS latiNo
			, CMC.CAR_TYPE        AS carType
			, fn_commcd_cmnm('VHCOPTY', CMC.CAR_CLS_CD)   AS carClsNm
			, fn_commcd_cmnm('DLVTYPE', CMC.CAR_OPR_CD)   AS carOprNm
			, fn_commcd_cmnm('VHCTYPE', CMC.CAR_MOD_CD)   AS carModNm
			, fn_commcd_cmnm('SKUGR01', CMC.CAR_TEMP_CD)   AS carTempNm
			, SHC.SH_NO           AS shNo
			, SHC.SH_USE_YN
		    , COALESCE(FN_COMMCD_CMNM('SH_USE_YN', SHC.SH_USE_YN), '미등록') AS shUseYnNm
			, SHC.SH_PRD_CLS       AS shPrdCls
			, SHC.SH_PRD           AS shPrd
			, SHC.SH_SQU           AS shSqu
			, SHC.SH_LK_CLS        AS shLkCls
			, CASE WHEN SHC.SH_PRC > 0 THEN SHC.SH_PRC
			       ELSE CMC.CM_PRICE
			   END AS shPrc
			, SHC.SH_LT_DT        AS shLtDt
			, ADC.PASS_YN         AS passYn
			, ADC.DIVI_YN         AS diviYn
			, ADC.GERA_YN         AS geraYn
			, ADC.AIR_YN          AS airYn
			, ADC.CAR_RELE_DT     AS carReleDt
			, ADC.CAR_YEAR        AS carYear
			, ADC.CAR_TEMP_YN     AS carTempYn
			, ADC.CAR_GPS_YN      AS carGpsYn
			, ADC.CAR_PHOT        AS carPhot
			, ADC.CAR_PHOT2       AS carPhot2
			, ADC.CAR_PHOT3       AS carPhot3
			, ADC.CAR_CARD        AS carCard
		 FROM GJ_DS.CM_CAR CMC
		 LEFT JOIN GJ_DS.AD_CAR ADC
		   ON CMC.CAR_ID = ADC.CAR_ID
		  AND ADC.USER_ID = CMC.USER_ID
		 LEFT JOIN (
			SELECT SC.CAR_ID
				 , SC.USER_ID
				 , SC.SH_NO
				 , SC.SH_PRD_CLS
				 , SC.SH_PRD
				 , SC.SH_SQU
				 , SC.SH_LK_CLS
				 , SC.SH_PRC
				 , SC.SH_LT_DT
			     , SC.SH_USE_YN
			     , SC.USE_YN
			  FROM SH_CAR SC
			  JOIN (SELECT MAX(SH_NO) AS SH_NO FROM SH_CAR GROUP BY CAR_ID) SC2
				ON SC.SH_NO = SC2.SH_NO
			  ) SHC
		   ON CMC.CAR_ID = SHC.CAR_ID
		  AND CMC.USER_ID = SHC.USER_ID
		WHERE CMC.USER_ID = #{userId}
		  AND CMC.USE_YN != 'D'
		<if test='carFullNo != null and !carFullNo.equals("")'>
		  AND CMC.CAR_FULL_NO LIKE concat('%', #{carFullNo}, '%')
		</if>
		<if test='cpCd != null and !cpCd.equals("")'>
		  AND CMC.CAR_CP_CD LIKE concat('%', #{cpCd}, '%')
		</if>
		<if test='useYn != null and !useYn.equals("")'>
		  AND CMC.USE_YN = #{useYn}
		</if>
		<if test='shUseYn != null and !shUseYn.equals("")'>
		  AND COALESCE(SHC.SH_USE_YN, 'E') = #{shUseYn}
		</if>
		ORDER BY CMC.USE_YN DESC, FIELD(IFNULL(SHC.SH_USE_YN, 'E'), 'E', 'R', 'A', 'S'), CMC.CRE_DT DESC
	</select>

	<!-- 차량 부가정보 목록 조회 -->
	<select id="getAdCarList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		/* com.rs.mapper.CarMapper [getAdCarList] */
		SELECT CC.CAR_ID as carId
			 , CC.CAR_FULL_NO
			 , CC.CAR_LOD_WGT
			 , CC.USE_YN
			 , FN_CAR_STATE(AC.CAR_ID) AS SH_USE_YN_NM
			 , CASE WHEN CC.USE_YN = 'Y' THEN '사용'
					WHEN CC.USE_YN = 'N' THEN '미사용'
				END AS USE_YN_NM
			 , AC.PASS_YN AS passYn
			 , AC.DIVI_YN AS diviYn
			 , AC.GERA_YN AS geraYn
			 , AC.AIR_YN AS airYn
			 , AC.CAR_RELE_DT AS carReleDt
			 , AC.CAR_YEAR AS carYear
			 , AC.CAR_TEMP_YN AS carTempYn
			 , AC.CAR_GPS_YN AS carGpsYn
			 , AC.CAR_PHOT AS carPhot
			 , AC.CAR_PHOT2 AS carPhot2
			 , AC.CAR_PHOT3 AS carPhot3
			 , AC.CAR_CARD AS carCard
			 , SC.SH_USE_YN
		  FROM CM_CAR CC
		  LEFT JOIN AD_CAR AC
			ON CC.CAR_ID = AC.CAR_ID
		  LEFT JOIN (
			SELECT SC.SH_NO
				 , SC.CAR_ID
				 , SC.SH_USE_YN
			  FROM SH_CAR SC
			  JOIN (SELECT MAX(SH_NO) AS SH_NO FROM SH_CAR SCC GROUP BY CAR_ID) SC2
				ON SC.SH_NO = SC2.SH_NO
			   ) SC
			ON AC.CAR_ID = SC.CAR_ID
		 WHERE CC.USE_YN != 'D'
		   AND CC.CRE_USER_ID = #{userId}
		<if test='carFullNo != null and !carFullNo.equals("")'>
		   AND CC.CAR_FULL_NO LIKE CONCAT('%',#{carFullNo},'%')
		</if>
		<if test='carCpCd != null and !carCpCd.equals("")'>
		   AND CC.CAR_CP_CD LIKE CONCAT('%',#{carCpCd},'%')
		</if>
		<if test='useYn != null and !useYn.equals("")'>
		   AND CC.USE_YN = #{useYn}
		</if>
		<choose>
			<when test='shUseYn != null and shUseYn.equals("E")'>
				AND (SC.SH_USE_YN IS NULL OR SC.SH_USE_YN = 'E')
			</when>
			<when test='shUseYn != null and !shUseYn.equals("")'>
				AND SC.SH_USE_YN = #{shUseYn}
			</when>
		</choose>
		 ORDER BY CC.USE_YN DESC, SC.SH_USE_YN DESC
	</select>

	<select id="getMdCarList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		/* com.rs.mapper.CarMapper [getMdCarList] */
		SELECT OID AS value
			 , CAR_TYPE AS text
			 , WEIGHT AS CAR_LOD_WGT
			 , WIDTH AS CAR_LOD_WDT
			 , LENGTH AS CAR_LOD_LEN
			 , HEIGHT AS CAR_LOD_HGT
			 , CBM AS CAR_LOD_CBM
		  FROM MD_CAR
		 WHERE USE_YN = 'Y'
		<if test="oid != null and !oid.equals('')">
		   AND OID = #{oid}
		</if>
	</select>

	<insert id="insertCmCar" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="carId" keyColumn="CAR_ID">
		/* com.rs.mapper.CarMapper [insertCmCar] */
		<selectKey order="BEFORE" keyProperty="carId" resultType="String">
			SELECT CONCAT('CC', LPAD(CAST(NEXTVAL(cm_car_seq) AS VARCHAR(8)), 8, '0'))
		</selectKey>

		INSERT INTO GJ_DS.CM_CAR
			( USER_ID
			, CAR_ID
			, CAR_NO
			, CAR_FULL_NO
			, CAR_CP_CD
			, CAR_CP_NM
			, BR_NO
			, SH_YN
			, USE_YN
			, DRIVER_NM
			, CAR_CLS_CD
			, CAR_OPR_CD
			, CAR_TEMP_CD
			, CAR_MOD_CD
			, CAR_LOD_CBM
			, CAR_LOD_WGT
			, CAR_LOD_WDT
			, CAR_LOD_LEN
			, CAR_LOD_HGT
			, CAR_INSR_YN
			, CAR_INSR_DT
			, CAR_LOD_INSR_YN
			, CM_PRICE
			, AREA_NM1
			, AREA_NM2
			, DT_ADDR
			, DT_ADDR2
			, LONGI_NO
			, LATI_NO
			, CAR_TYPE
			, CRE_DT
			, CRE_USER_ID
			, MOD_DT
			, MOD_USER_ID
			) VALUES (
			   #{userId}
			 , #{carId}
			 , #{carNo}
			 , #{carFullNo}
			 , #{carCpCd}
			 , #{carCpCd}
			 , REPLACE(#{brNo},'-','')
			 , 'N'
			 , #{useYn}
			 , #{driverNm}
			 , #{carClsCd}
			 , #{carOprCd}
			 , #{carTempCd}
			 , #{carModCd}
			 , #{carLodCbm}
			 , #{carLodWgt}
			 , #{carLodWdt}
			 , #{carLodLen}
			 , #{carLodHgt}
			 , #{carInsrYn}
			 , #{carInsrDt}
			 , #{carLodInsrYn}
			 , REPLACE(NULLIF(#{cmPrice},''),",","")
			 , #{areaNm1}
			 , #{areaNm2}
			 , #{dtAddr}
			 , #{dtAddr2}
			 , #{longiNo}
			 , #{latiNo}
			 , #{carType}
			 , NOW()
			 , #{userId}
			 , NOW()
			 , #{userId}
			)
	</insert>

	<update id="updateCmCar" parameterType="java.util.HashMap" >
		/* com.rs.mapper.CarMapper : updateCmCar */
		UPDATE CM_CAR
		   SET USER_ID = #{userId}
			 , CAR_ID = #{carId}
			 , CAR_NO = #{carNo}
			 , CAR_FULL_NO = #{carFullNo}
			 , CAR_CP_CD = #{carCpCd}
			 , CAR_CP_NM = #{carCpCd}
			 , BR_NO = REPLACE(#{brNo},'-','')
			 , SH_YN = #{shYn}
			 , USE_YN = #{useYn}
			 , DRIVER_NM = #{driverNm}
			 , CAR_CLS_CD = #{carClsCd}
			 , CAR_OPR_CD = #{carOprCd}
			 , CAR_TEMP_CD = #{carTempCd}
			 , CAR_MOD_CD = #{carModCd}
			 , CAR_LOD_CBM = #{carLodCbm}
			 , CAR_LOD_WGT = #{carLodWgt}
			 , CAR_LOD_WDT = #{carLodWdt}
			 , CAR_LOD_LEN = #{carLodLen}
			 , CAR_LOD_HGT = #{carLodHgt}
			 , CAR_INSR_YN = #{carInsrYn}
			 , CAR_INSR_DT = #{carInsrDt}
			 , CAR_LOD_INSR_YN = #{carLodInsrYn}
			 , CM_PRICE = REPLACE(NULLIF(#{cmPrice},''),",","")
			 , AREA_NM1 = #{areaNm1}
			 , AREA_NM2 = #{areaNm2}
			 , DT_ADDR = #{dtAddr}
			 , DT_ADDR2 = #{dtAddr2}
			 , LONGI_NO = #{longiNo}
			 , LATI_NO = #{latiNo}
			 , CAR_TYPE = #{carType}
			 , MOD_DT = NOW()
			 , MOD_USER_ID = #{userId}
		 WHERE CAR_ID = #{carId}
	</update>

	<update id="deleteCmCar" parameterType="java.util.HashMap" >
		/* com.rs.mapper.CarMapper : deleteCmCar */
		UPDATE CM_CAR
		   SET USE_YN = 'D'
		     , MOD_DT = NOW()
		     , MOD_USER_ID = #{userId}
		 WHERE CAR_ID = #{carId}
	</update>
	
	<!-- 차량 부가정보 저장 -->
	<insert id="insertAdCar" parameterType="java.util.HashMap" >
		INSERT INTO GJ_DS.AD_CAR
		(	   USER_ID
			 , CAR_ID
			 , PASS_YN
			 , DIVI_YN
			 , GERA_YN
			 , AIR_YN
			 , CAR_RELE_DT
			 , CAR_YEAR
			 , CAR_TEMP_YN
			 , CAR_GPS_YN
			 , CAR_PHOT
			 , CAR_PHOT2
			 , CAR_PHOT3
			 , CAR_CARD
			 , CRE_DT
			 , CRE_USER_ID
			 , MOD_DT
			 , MOD_USER_ID
		)
		VALUES
		(	   #{userId}
			 , #{carId}
			 , #{passYn}
			 , #{diviYn}
			 , #{geraYn}
			 , #{airYn}
			 , IF(#{carReleDt} = '', NULL, #{carReleDt})
			 , #{carYear}
			 , #{carTempYn}
			 , #{carGpsYn}
			 , #{carPhot}
			 , #{carPhot2}
			 , #{carPhot3}
			 , #{carCard}
			 , NOW()
			 , #{userId}
			 , NOW()
			 , #{userId}
		)
	</insert>

	<!-- 차량 부가정보 저장 -->
	<update id="updateAdCar" parameterType="java.util.HashMap" >
		UPDATE GJ_DS.AD_CAR
		   SET USER_ID 	   = #{userId}
			 , PASS_YN     = #{passYn}
			 , DIVI_YN     = #{diviYn}
			 , GERA_YN     = #{geraYn}
			 , AIR_YN      = #{airYn}
			 , CAR_RELE_DT = IF(#{carReleDt} = '', NULL, #{carReleDt})
			 , CAR_YEAR    = #{carYear}
			 , CAR_TEMP_YN = #{carTempYn}
			 , CAR_GPS_YN  = #{carGpsYn}
			 , CAR_PHOT    = #{carPhot}
			 , CAR_PHOT2   = #{carPhot2}
			 , CAR_PHOT3   = #{carPhot3}
			 , CAR_CARD    = #{carCard}
			 , MOD_DT      = NOW()
			 , MOD_USER_ID = #{userId}
		 WHERE CAR_ID = #{carId}
	</update>

	<!-- 차량 공유정보 목록 조회 -->
	<select id="getShCarList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT #{userNm} AS userNm
		     , CMC.USER_ID AS userId
		     , CMC.CAR_ID AS carId
		     , CMC.CAR_NO AS carNo
			 , CMC.CAR_FULL_NO AS carFullNo
			 , CMC.CAR_CP_CD AS carCpCd
			 , CMC.CAR_CP_NM AS carCpNm
			 , CONCAT(SUBSTR(BR_NO,1,3),'-',SUBSTR(BR_NO,4,2),'-',SUBSTR(BR_NO,6)) AS brNo
			 , fn_car_state(CMC.CAR_ID) AS shYn
			 , CMC.USE_YN AS useYn
			 , CMC.DRIVER_NM AS driverNm
			 , CMC.CAR_CLS_CD AS carClsCd
			 , CMC.CAR_OPR_CD AS carOprCd
			 , fn_commcd_cmnm('SKUGR01', CMC.CAR_TEMP_CD) AS carTempCd
			 , CMC.CAR_MOD_CD AS carModCd
			 , CMC.CAR_LOD_CBM AS carLodCbm
			 , CMC.CAR_LOD_WGT AS carLodWgt
			 , CMC.CAR_LOD_WDT AS carLodWdt
			 , CMC.CAR_LOD_LEN AS carLodLen
			 , CMC.CAR_LOD_HGT AS carLodHgt
			 , CMC.CAR_INSR_YN AS carInsrYn
			 , CMC.CAR_INSR_DT AS carInsrDt
			 , CMC.CAR_LOD_INSR_YN AS carLodInsrYn
			 , CMC.CM_PRICE AS cmPrice
			 , FN_COMMCD_CMNM('VHCOPTY', CMC.CAR_CLS_CD) AS carClsNm
			 , FN_COMMCD_CMNM('DLVTYPE', CMC.CAR_OPR_CD) AS carOprNm
			 , FN_COMMCD_CMNM('VHCTYPE', CMC.CAR_MOD_CD) AS carModNm
			 , FN_COMMCD_CMNM('SKUGR01', CMC.CAR_TEMP_CD) AS carTempNm
			 , SHC.SH_NO AS shNo
			 , COALESCE(SHC.SH_USE_YN, '') AS shUseYn
			 , COALESCE(SHC.SH_USE_YN, '') AS editShUseYn
			 , COALESCE(FN_COMMCD_CMNM('SH_USE_YN', SHC.SH_USE_YN), '미등록') AS shUseYnNm
			 , COALESCE(SHC.SH_PRD_CLS, '') AS shPrdCls
			 , COALESCE(SHC.SH_PRD, '') AS shPrd
			 , COALESCE(SHC.SH_SQU, '') AS shSqu
			 , COALESCE(SHC.SH_LK_CLS, '') AS shLkCls
			 , CASE WHEN SHC.SH_PRC > 0 THEN SHC.SH_PRC
			     	ELSE CMC.CM_PRICE
			    END AS shPrc
			 , COALESCE(SHC.SH_LT_DT, '') AS shLtDt
			 , ADC.PASS_YN AS passYn
			 , ADC.DIVI_YN AS diviYn
			 , ADC.GERA_YN AS geraYn
			 , ADC.AIR_YN AS airYn
			 , ADC.CAR_RELE_DT AS carReleDt
			 , ADC.CAR_YEAR AS carYear
			 , ADC.CAR_TEMP_YN AS carTempYn
			 , ADC.CAR_GPS_YN AS carGpsYn
			 , ADC.CAR_PHOT AS carPhot
			 , ADC.CAR_CARD AS carCard
		  FROM GJ_DS.CM_CAR CMC
		  LEFT JOIN GJ_DS.AD_CAR ADC
		    ON ADC.USER_ID = CMC.USER_ID
		   AND ADC.CAR_ID  = CMC.CAR_ID
		  LEFT JOIN (
			SELECT CAR_ID
			     , USER_ID
			     , SC.SH_NO
				 , SH_USE_YN AS SH_USE_YN
				 , SH_PRD_CLS AS SH_PRD_CLS
				 , SH_PRD AS SH_PRD
				 , SH_SQU AS SH_SQU
				 , SH_LK_CLS AS SH_LK_CLS
				 , SH_PRC
				 , SH_LT_DT
			  FROM SH_CAR SC
			  JOIN (SELECT MAX(SH_NO) AS SH_NO FROM SH_CAR GROUP BY CAR_ID) SCC
				ON SC.SH_NO = SCC.SH_NO
			 WHERE SC.USE_YN = 'Y'
			 ) AS SHC
		    ON CMC.CAR_ID = SHC.CAR_ID
		   AND CMC.USER_ID = SHC.USER_ID
		 WHERE CMC.USER_ID = #{userId}
		   AND CMC.USE_YN != 'D'
		   AND CMC.USE_YN = 'Y'
		  <if test='condCarFullNo != null and condCarFullNo != ""'>
		AND CMC.CAR_FULL_NO LIKE CONCAT('%',#{condCarFullNo},'%')
		</if>
		<if test='condCarCpCd != null and condCarCpCd != ""'>
		AND CMC.CAR_CP_NM = #{condCarCpCd}
		</if>
		<if test='condShareYn != null and condShareYn != ""'>
		AND SHC.SH_USE_YN = #{condShareYn}
		</if>
		
		
		ORDER BY CMC.CAR_ID
	</select>

	<!-- 차량 공유정보 저장 -->
	<update id="saveCarShareInfo" parameterType="java.util.HashMap" >
		<selectKey resultType="string" keyProperty="shNo" order="BEFORE">
			SELECT COALESCE(#{shNo}, CONCAT('SC',LPAD(NEXTVAL(sh_car_seq), 8, '0')))
		</selectKey>

		INSERT INTO GJ_DS.SH_CAR
		(
			 SH_NO
			,SH_DT
			,USER_ID
			,CAR_ID
			,SH_PRD_CLS
			,SH_PRD
			,SH_SQU
			,SH_LK_CLS
			,SH_PRC
			,SH_LT_DT
			,SH_USE_YN
			,USE_YN
			,CRE_DT
			,CRE_USER_ID
			,MOD_DT
			,MOD_USER_ID
		)VALUES(
			  #{shNo}
			, NOW()
			, #{userId}
			, #{carId}
			, #{shPrdCls}
			, #{shPrd}
			, #{shSqu}
			, #{shLkCls}
			, REPLACE(#{shPrc},",","")
			, #{shLtDt}
			, #{shUseYn}
			, 'Y'
			, NOW()
			, #{userId}
			, NOW()
			, #{userId}
		)
		ON DUPLICATE KEY UPDATE
			  SH_DT       = NOW()
			, USER_ID     = #{userId}
			, CAR_ID      = #{carId}
			, SH_PRD_CLS  = #{shPrdCls}
			, SH_PRD      = #{shPrd}
			, SH_SQU      = #{shSqu}
			, SH_LK_CLS   = #{shLkCls}
			, SH_PRC      = REPLACE(#{shPrc},",","")
			, SH_LT_DT    = #{shLtDt}
			, SH_USE_YN   = #{shUseYn}
			, USE_YN      = #{useYn}
			, MOD_DT      = NOW()
			, MOD_USER_ID = #{userId}
	</update>
	
	<!-- 차량 기본정보 공유여부 저장 -->
	<update id="updateCarShareInfo" parameterType="java.util.HashMap" >
		UPDATE GJ_DS.CM_CAR
		   SET SH_YN = 'Y'
		 WHERE USER_ID = #{userId}
		   AND CAR_ID  = #{carId}
	</update>
	
	<!-- 차량 공유정보 종료 대상 목록 조회 -->
	<select id="getCarShareEndTrgtList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT
			 CMC.USER_ID
			,CMC.CAR_ID
			,CMC.CAR_NO
			,CMC.CAR_FULL_NO
			,CMC.CAR_CP_CD
			,CMC.CAR_CP_NM
			,CONCAT(SUBSTR(BR_NO,1,3),'-',SUBSTR(BR_NO,4,2),'-',SUBSTR(BR_NO,6)) AS BR_NO
			,CMC.SH_YN
			,CMC.USE_YN
			,CMC.DRIVER_NM
			,CMC.CAR_CLS_CD
			,CMC.CAR_OPR_CD
			,CMC.CAR_TEMP_CD
			,CMC.CAR_MOD_CD
			
			,CMC.CAR_LOD_CBM
			,CMC.CAR_LOD_WGT
			,CMC.CAR_LOD_WDT
			,CMC.CAR_LOD_LEN
			,CMC.CAR_LOD_HGT
			,CMC.CAR_INSR_YN
			,CMC.CAR_INSR_DT
			,CMC.CAR_LOD_INSR_YN
			,(SELECT CC.CMNM FROM GJ_OP.COMMGRP CG, GJ_OP.COMMCD CC WHERE CG.CMGRPCD = CC.CMGRPCD AND CG.ACTYN = 'Y' AND CC.ACTYN = 'Y' AND CG.CMGRPCD = 'VHCOPTY' AND CC.CMCD = CMC.CAR_CLS_CD) CAR_CLS_NM
			,(SELECT CC.CMNM FROM GJ_OP.COMMGRP CG, GJ_OP.COMMCD CC WHERE CG.CMGRPCD = CC.CMGRPCD AND CG.ACTYN = 'Y' AND CC.ACTYN = 'Y' AND CG.CMGRPCD = 'VHCTYPE' AND CC.CMCD = CMC.CAR_MOD_CD) CAR_MOD_NM
			,(SELECT CC.CMNM FROM GJ_OP.COMMGRP CG, GJ_OP.COMMCD CC WHERE CG.CMGRPCD = CC.CMGRPCD AND CG.ACTYN = 'Y' AND CC.ACTYN = 'Y' AND CG.CMGRPCD = 'DLVTYPE' AND CC.CMCD = CMC.CAR_OPR_CD) CAR_OPR_NM
			,(SELECT CC.CMNM FROM GJ_OP.COMMGRP CG, GJ_OP.COMMCD CC WHERE CG.CMGRPCD = CC.CMGRPCD AND CG.ACTYN = 'Y' AND CC.ACTYN = 'Y' AND CG.CMGRPCD = 'SKUGR01' AND CC.CMCD = CMC.CAR_TEMP_CD) CAR_TEMP_NM
			,SHC.SH_NO
			,SHC.SH_DT
			,SHC.USER_ID
			,SHC.CAR_ID
			,SHC.SH_PRD_CLS
			,CASE
				WHEN SHC.SH_PRD_CLS = 'YEAR'  THEN '년'
				WHEN SHC.SH_PRD_CLS = 'MONTH' THEN '월'
				WHEN SHC.SH_PRD_CLS = 'DAY'   THEN '일'
			 END AS SH_PRD_CLS_NM
			,SHC.SH_PRD
			,(CASE WHEN SHC.SH_SQU = 'Y' THEN '사용' ELSE '미사용' END) AS SH_SQU
			,(CASE WHEN SHC.SH_LK_CLS = 'Y' THEN '사용' ELSE '미사용' END) AS SH_LK_CLS
			,FORMAT(SHC.SH_PRC, N'#,0') AS SH_PRC_FMD
			,SHC.SH_LT_DT
			,SHC.SH_USE_YN
			,COALESCE((SELECT CC.CMNM FROM GJ_OP.COMMGRP CG, GJ_OP.COMMCD CC WHERE CG.CMGRPCD = CC.CMGRPCD AND CG.ACTYN = 'Y' AND CC.ACTYN = 'Y' AND CG.CMGRPCD = 'SH_USE_YN' AND CC.CMCD = SHC.SH_USE_YN), '미등록') AS SH_USE_YN_NM
			,SHC.USE_YN
		FROM GJ_DS.CM_CAR CMC
		INNER JOIN GJ_DS.SH_CAR SHC
		 ON SHC.USER_ID = CMC.USER_ID
		AND SHC.CAR_ID  = CMC.CAR_ID
		WHERE 1=1
		<if test='condCarNo != null and condCarNo != ""'>
		AND CMC.CAR_NO LIKE CONCAT('%',#{condCarNo},'%')
		</if>
		<if test='condCarFullNo != null and condCarFullNo != ""'>
		AND CMC.CAR_FULL_NO LIKE CONCAT('%',#{condCarFullNo},'%')
		</if>
		<if test='condCarCpCd != null and condCarCpCd != ""'>
		AND CMC.CAR_CP_NM = #{condCarCpCd}
		</if>
		<if test='condShareYn != null and condShareYn != ""'>
		AND SHC.SH_USE_YN = #{condShareYn}
		</if>
		<if test='condBrNo != null and condBrNo != ""'>
		AND CMC.BR_NO LIKE CONCAT('%',#{condBrNo},'%')
		</if>
		AND CMC.USE_YN = 'Y'
		AND SHC.USE_YN  = 'Y'
		AND SHC.SH_USE_YN IN ('R','A','S','E')
		AND CMC.USER_ID = #{userId}
		ORDER BY CMC.CAR_ID
	</select>
	
	<!-- 차량 공유정보 공유 종료 -->
	<update id="endCarShareSh" parameterType="java.util.HashMap" >
		UPDATE GJ_DS.SH_CAR SET
			 SH_USE_YN   = 'E'            
			,MOD_DT      = NOW()
			,MOD_USER_ID = #{userId}
		WHERE SH_NO IN 
		<foreach item="item" collection="dataList" separator="," open="(" close=")">
			#{item.SH_NO}
		</foreach>
	</update>
	
	<!-- 차량 기본정보 공유 종료 -->
	<update id="endCarShareCm" parameterType="java.util.HashMap" >
		UPDATE GJ_DS.CM_CAR SET
			 SH_YN       = 'E'            
			,MOD_DT      = NOW()
			,MOD_USER_ID = #{userId}
		WHERE 1=1
		AND USER_ID = #{userId} 
		AND CAR_ID IN
		<foreach item="item" collection="dataList" separator="," open="(" close=")">
			#{item.CAR_ID}
		</foreach>
	</update>
	
	<!-- 차량 모바일 기본정보 목록 건 수 -->
	<select id="getMoCarBasicInfoCnt" parameterType="java.util.HashMap" resultType="int">
		SELECT
			 COUNT(*)
		FROM GJ_DS.CM_CAR CMC
		LEFT OUTER JOIN GJ_DS.AD_CAR ADC
		 ON ADC.USER_ID = CMC.USER_ID
		AND ADC.CAR_ID  = CMC.CAR_ID
		LEFT OUTER JOIN GJ_DS.SH_CAR SHC
		 ON SHC.USER_ID = CMC.USER_ID
		AND SHC.CAR_ID  = CMC.CAR_ID
		AND SHC.USE_YN  = 'Y'
		AND SHC.SH_USE_YN IN ('R','S','A')
		WHERE 1=1
		<if test='condCarNo != null and condCarNo != ""'>
			AND CMC.CAR_NO LIKE CONCAT('%',#{condCarNo},'%')
		</if>
		<if test='condCarCpNm != null and condCarCpNm != ""'>
			AND CMC.CAR_CP_NM LIKE CONCAT('%', #{condCarCpNm}, '%')
		</if>
		<if test='condShYn != null and condShYn != ""'>
			AND CMC.SH_YN = #{condShYn}
		</if>
		<if test='condBrNo != null and condBrNo != ""'>
			AND CMC.BR_NO LIKE CONCAT('%', REPLACE(#{condBrNo},'-',''), '%')
		</if>
		AND CMC.USE_YN IN ('Y','N')
	</select>
	
	<!-- 차량 모바일 기본정보 목록 조회 -->
	<select id="getMoCarBasicInfoList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		SELECT CMC.USER_ID         AS userId
			 , CMC.CAR_ID          AS carId
			 , CMC.CAR_NO          AS carNo
			 , CMC.CAR_FULL_NO     AS carFullNo
			 , CMC.CAR_CP_CD       AS carCpCd
			 , CMC.CAR_CP_NM       AS carCpNm
			 , CONCAT(SUBSTR(BR_NO,1,3),'-',SUBSTR(BR_NO,4,2),'-',SUBSTR(BR_NO,6)) AS brNo
			 , CMC.USE_YN          AS useYn
			 , CMC.DRIVER_NM       AS driverNm
			 , CMC.CAR_CLS_CD      AS carClsCd
			 , CMC.CAR_OPR_CD      AS carOprCd
			 , CMC.CAR_TEMP_CD     AS carTempCd
			 , CMC.CAR_MOD_CD      AS carModCd
			 , CMC.CAR_TYPE        AS carType
			 , CMC.CAR_LOD_CBM     AS carLodCbm
			 , CMC.CAR_LOD_WGT     AS carLodWgt
			 , CMC.CAR_LOD_WDT     AS carLodWdt
			 , CMC.CAR_LOD_LEN     AS carLodLen
			 , CMC.CAR_LOD_HGT     AS carLodHgt
			 , CMC.DT_ADDR         AS dtAddr
			 , CMC.DT_ADDR2        AS dtAddr2
			 , CMC.AREA_NM1        AS areaNm1
			 , CMC.AREA_NM2        AS areaNm2
			 , CMC.LONGI_NO        AS longiNo
			 , CMC.LATI_NO         AS latiNo
			 , CMC.CAR_LOD_INSR_YN AS carLodInsrYn
			 , CMC.CAR_INSR_YN     AS carInsrYn
			 , CMC.CAR_INSR_DT     AS carInsrDt
			 , CMC.CM_PRICE        AS cmPrice
			 , ADC.PASS_YN         AS passYn
			 , ADC.DIVI_YN         AS diviYn
			 , ADC.GERA_YN         AS geraYn
			 , ADC.AIR_YN          AS airYn
			 , ADC.CAR_RELE_DT     AS carReleDt
			 , ADC.CAR_YEAR        AS carYear
			 , ADC.CAR_TEMP_YN     AS carTempYn
			 , ADC.CAR_GPS_YN      AS carGpsYn
			 , ADC.CAR_PHOT        AS carPhot
			 , ADC.CAR_PHOT2       AS carPhot2
			 , ADC.CAR_PHOT3       AS carPhot3
			 , ADC.CAR_CARD        AS carCard
			 , ADC.CAR_CARD2       AS carCard2
			 , ADC.CAR_CARD3       AS carCard3
			 , SHC.SH_NO           AS shNo
			 , SHC.SH_USE_YN	   AS shUseYn
		     , fn_car_state(CMC.CAR_ID) AS shUseYnNm
			 , SHC.CRE_USER_ID	   AS shUserId
			 , SHC.SH_PRD_CLS      AS shPrdCls
			 , SHC.SH_PRD          AS shPrd
			 , SHC.SH_SQU          AS shSqu
			 , SHC.SH_LK_CLS       AS shLkCls
			 , SHC.SH_LT_DT        AS shLtDt
			 , SM.MAT_NO AS matNo
			 , SM.CON_ID AS manConId
			 , SB.COM_NO AS comNo
			 , SB.REQ_MARK AS reqMark
			 , SB.CON_ID AS matConId
		  FROM GJ_DS.CM_CAR CMC
		  LEFT JOIN GJ_DS.AD_CAR ADC
			ON CMC.CAR_ID = ADC.CAR_ID
		   AND ADC.USER_ID = CMC.USER_ID
		  LEFT JOIN (
			SELECT SC.CAR_ID
				 , SC.USER_ID
				 , SC.SH_NO
				 , SC.SH_PRD_CLS
				 , SC.SH_PRD
				 , SC.SH_SQU
				 , SC.SH_LK_CLS
				 , SC.SH_PRC
				 , SC.SH_LT_DT
				 , SC.SH_USE_YN
				 , SC.CRE_USER_ID
				 , SC.USE_YN
			  FROM SH_CAR SC
			  JOIN (SELECT MAX(SH_NO) AS SH_NO FROM SH_CAR GROUP BY CAR_ID) SC2
				ON SC.SH_NO = SC2.SH_NO
				   ) SHC
			ON CMC.CAR_ID = SHC.CAR_ID
		   AND CMC.USER_ID = SHC.USER_ID
		  LEFT JOIN SH_MATCH SM
			ON SHC.SH_NO = SM.SH_NO
		   AND SM.MAT_CD = 'W'
		   AND SM.MAT_YN = 'A'
		  LEFT JOIN (
			SELECT SB.COM_NO
				 , SB.CON_ID
				 , SB.SH_NO
				 , SB.REQ_MARK
			  FROM SH_BOARD SB
			  JOIN (SELECT MAX(COM_NO) AS COM_NO FROM SH_BOARD WHERE RES_MARK IS NULL) SB2
				ON SB.COM_NO = SB2.COM_NO) SB
			ON SHC.SH_NO = SB.SH_NO
		 WHERE CMC.USER_ID = #{userId}
		   AND CMC.USE_YN != 'D'
		<if test='useYn != null and !useYn.equals("")'>
			AND CMC.USE_YN = #{useYn}
		</if>
		ORDER BY CMC.USE_YN DESC, FIELD(IFNULL(SHC.SH_USE_YN, 'E'), 'E', 'R', 'A', 'S'), CMC.CRE_DT DESC
	</select>

	<insert id="insertMoShCar" parameterType="java.util.HashMap" >
		/* mapper.rs.carMapper : insertMoShCar */
		INSERT INTO GJ_DS.SH_CAR
		(
		         SH_NO
		       , SH_DT
		       , USER_ID
		       , CAR_ID
		       , SH_USE_YN
		       , SH_PRD_CLS
		       , SH_PRD
		       , SH_SQU
		       , SH_LK_CLS
		       , SH_LT_DT
		       , USE_YN
		       , CRE_DT
		       , CRE_USER_ID
		       , MOD_DT
		       , MOD_USER_ID
		)
		VALUES (
				 CONCAT('CA',LPAD(NEXTVAL(sh_car_seq), 8, 0))
			   , DATE_FORMAT(NOW(),'%Y%m%d')
			   , #{userId}
			   , #{carId}
			   , #{shUseYn}
			   , #{shPrdCls}
			   , REPLACE(#{shPrd}, ',', '')
			   , REPLACE(#{shSqu}, ',', '')
			   , #{shLkCls}
			   , #{shLtDt}
			   , 'Y'
			   , NOW()
			   , #{userId}
			   , NOW()
			   , #{userId}
		)
	</insert>

	<update id="updateMoShCar" parameterType="java.util.HashMap">
		/*mapper.rs.carMapper : updateMoShCar */
		UPDATE GJ_DS.SH_CAR
		   SET SH_USE_YN = #{shUseYn}
		     , SH_PRD = REPLACE(#{shPrd}, ',', '')
		     , SH_SQU = REPLACE(#{shSqu}, ',', '')
		     , SH_LK_CLS = #{shLkCls}
		     , SH_LT_DT = #{shLtDt}
		     , SH_PRD_CLS = #{shPrdCls}
		     , MOD_DT = NOW()
		     , MOD_USER_ID = #{userId}
		 WHERE USER_ID = #{userId}
		   AND SH_NO = #{shNo}
	</update>

	<update id="updateMoCarShYn" parameterType="java.util.HashMap">
		/*mapper.rs.carMapper : updateMoCarShYn */
		UPDATE GJ_DS.CM_CAR
		   SET SH_YN = 'Y'
		     , MOD_USER_ID = #{userId}
		     , MOD_DT = NOW()
		 WHERE USER_ID = #{userId}
		   AND CAR_ID = #{carId}
	</update>

	<select id="getMoMdCarList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		/* com.rs.mapper.CarMapper [getMoMdCarList] */
		SELECT OID AS value
			 , CAR_TYPE AS text
			 , WEIGHT AS carLodWgt
			 , WIDTH AS carLodWdt
			 , LENGTH AS carLodLen
			 , HEIGHT AS carLodHgt
			 , CBM AS carLodCbm
		  FROM MD_CAR
		 WHERE USE_YN = 'Y'
		<if test="oid != null and !oid.equals('')">
			AND OID = #{oid}
		</if>
	</select>

</mapper>